{% extends '_second_nav.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'reader/css/profile.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mt-3 d-flex justify-content-between align-items-start">
        <div class="ps-5 col-lg-2 col-md-4 col-sm-12 border">
            <div class="menu-column d-flex justify-content-center justify-content-lg-start align-items-start">
                <ul class="list-unstyled">
                    <li class="menu-item">
                        <button class="btn-md custom-button mb-2 display-button" data-detail="billing">My Billing Details</button>
                    </li>
                    <li class="menu-item">
                        <button class="btn-md custom-button mb-2 display-button" data-detail="history">My Order History</button>
                    </li>
                    <!-- Change URL -->
                    <li class="menu-item">
                        <a href="{{ community_general_url }}">
                            <button class="btn-md custom-button mb-2">
                                My Communities
                            </button>
                        </a>
                    </li>
                    <li class="menu-item">
                        <button class="btn-md custom-button mb-2 display-button" data-detail="reviews">My Reviews</button>
                    </li>
                    <li class="menu-item">
                        <a href="{{ contact_url }}">
                            <button class="btn-md custom-button mb-2">
                                Need Help?
                            </button>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="col-lg-10 col-md-8 col-sm-12 order-first order-md-last pt-3 text-center border">
            <div class="profile-starter">
                <h5>Hey there! You've found your profile.</h5>
                <p>Click on a button on the left handside to view, change, or delete your information.</p>
            </div>
            <ul class="list-unstyled">
                <li class="profile-details d-none" data-profile="billing-details">
                    <div>
                        <h4 class="mb-3 text-uppercase small"><strong><i class="fa-solid fa-book me-2"></i>My Details</strong></h4>
                        <form action="{% url 'user_profile' %}" method="POST" id="userProfileForm">
                            {% csrf_token %}
                            {{ form | crispy }}
                            <div class="button-container d-flex justify-content-end mt-3">
                                <button type="submit" class="btn-lg custom-button"><small><i class="fa-solid fa-check me-2"></i>Save Info</small></button>
                            </div>
                        </form>
                    </div>
                </li>
                <li class="profile-details d-none" data-profile="history-details">
                    <div>
                        <h4 class="mb-3 text-uppercase small"><strong><i class="fa-solid fa-book me-2"></i>My Order History</strong></h4>
                        {% for book_order in book_orders %}
                        <div class="row accordion accordion-flush border my-2 px-3" id="accordion{{ forloop.counter }}">
                            <div class="col-lg-9 accordion-item d-flex flex-column justify-content-between">
                                <div class="info-container mt-3">
                                    <p class="m-0 p-0"><strong>Order Number : {{ book_order.order_number }}</strong></p>
                                    <p class="m-0 p-0"><small>Date placed: {{ book_order.date }}</small></p>
                                </div>
                                <div class="image-container d-flex">
                                    {% for book in book_order.booklineitem.all %}
                                    <!-- Add book image here -->
                                    <div style="max-width: 150px;" class="mx-3 mb-3 col-lg-2 d-flex flex-column justify-content-between">
                                        <div class="book-info">
                                            <img src="../../../static/images/1984_cover.jpg" class="mt-4 mb-2" style="width: 100px;" alt="{{ book.book.title }} book cover">
                                            <p class="m-0 p-0"><small><strong>{{ book.book.title }}</strong></small></p>
                                        </div>
                                        <p><small>( x {{ book.quantity }} )</small></p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-lg-3 d-flex flex-column justify-content-between">
                                <div class="info-container mt-3">
                                    <p class="m-0 p-0">Subtotal : €{{ book_order.order_total }}</p>
                                    <p class="m-0 p-0">Shipping : {% if book_order.delivery_cost == 0.00 %}<strong>FREE</strong>{% else %}€{{ book_order.delivery_cost }}{% endif %}</p>
                                    <p class="m-0 p-0">Total : €{{ book_order.grand_total }}</p>
                                </div>
                                <button class="custom-button mb-4 accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapse{{ forloop.counter }}" aria-expanded="false" aria-controls="flush-collapse{{ forloop.counter }}">
                                    <i class="fa-solid fa-truck-fast me-2"></i>Shipping Details
                                </button>
                            </div>
                            <div id="flush-collapse{{ forloop.counter }}" class="accordion-collapse collapse" aria-labelledby="flush-heading{{ forloop.counter }}" data-bs-parent="#accordionFlushExample">
                                <div class="accordion-body">
                                    <h6 class="my-3 text-uppercase"><strong>Shipping Address</strong></h6>
                                    <p class="my-0 p-0">{{ book_order.full_name }}</p>
                                    <p class="my-0 p-0">{{ book_order.street_1 }}</p>
                                    {% if book_order.street_2 %}
                                        <p class="my-0 p-0">{{ book_order.street_2 }}</p>
                                    {% endif %}
                                    <p class="my-0 p-0">{{ book_order.town_city }}</p>
                                    {% if book_order.county %}
                                        <p class="my-0 p-0">{{ book_order.county }}</p>
                                    {% endif %}
                                    {% if book_order.postcode %}
                                        <p class="my-0 p-0">{{ book_order.postcode }}</p>
                                    {% endif %}
                                    <p class="my-0 p-0">{{ book_order.country }}</p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </li>
                <li class="profile-details d-none" data-profile="reviews-details">
                    <div>
                        <h4 class="text-uppercase small"><strong><i class="fa-solid fa-book me-2"></i>My Reviews</strong></h4>
                        {% if user_reviews %}
                            <div class="row d-flex flex-row justify-content-center align-items-center">
                                {% for review in user_reviews %}
                                    <div class="outer-review d-flex flex-column justify-content-between col-lg-3 col-md-6 col-sm-12 bg-light shadow-sm p-2 rounded my-3">
                                        <div class="header">
                                            <p class="ms-2 small"><strong>{{ review.book.title }}</strong></p>
                                            <p class="ms-2 small">{{ review.book.author }}</p>
                                        </div>
                                        <div class="inner-review bg-white shadow-sm p-2 rounded m-2">
                                            <h6 class="strong"><small>{{ review.title }}</small></h6>
                                            <div class="rating-container d-flex">
                                                <div id="profile-rating-box-{{ forloop.counter }}" data-forloop="{{ forloop.counter }}" data-rating="{{ review.rating }}" class="review rating-box d-flex justify-content-start align-items-start mb-3">
                                                    <img src="../../../static/images/stars.png" alt="{{ book.title }} cover" width="120" id="profile-loader-image-{{ forloop.counter }}" class="loader-image">
                                                    <div id="profile-rating-bar-{{ forloop.counter }}" class="rating-bar"></div>
                                                </div>
                                            </div>
                                            <p>{{ review.comment }}</p>
                                        </div>
                                        <div class="footer">
                                            <p class="ms-2 small text-secondary">{{ review.reviewed_on }}</p>
                                            <p class="ms-2 mt-2 small {% if review.approved %}text-success{% endif %}">{% if review.approved %}<i class="fa-solid fa-circle-check fa-sm me-2"></i>Approved{% else %}<i class="fa-solid fa-hourglass-start fa-sm me-2"></i>Pending{% endif %}</p>
                                            <div class="button-container d-flex justify-content-between align-items-end">
                                                {% if not review.approved %}
                                                <button class="btn btn-sm btn-warning m-2 d-flex justify-content-center align-items-center btn-edit"
                                                data-review-id="{{ review.id }}" data-review-title="{{ review.title }}" data-review-comment="{{ review.comment }}" data-review-rating="{{ review.rating }}" data-book-title="{{ review.book }}">
                                                    <i class="fa-solid fa-pencil fa-sm me-2"></i>Edit
                                                </button>
                                                {% else %}
                                                <p class="ms-2 my-2 small text-muted">You can no longer edit this review.</p>
                                                {% endif %}

                                                <a href="{% url 'delete_review' review.id %}">
                                                    <button class="btn btn-sm btn-danger m-2 d-flex justify-content-center align-items-center">
                                                        <i class="fa-solid fa-trash fa-sm me-2"></i>Delete
                                                    </button>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p>You can view any pending and approved reviews here!</p>
                            <p>To leave a review go to <span><a href="{{ books_url }}">My Books</a></span></p>
                        {% endif %}
                    </div>
                </li>
            </ul>
        </div>
        <div class="slider-review border position-absolute col-lg-6 col-md-8 col-sm-12 bg-light d-none" id="review-slide">
            <form action="" method="post" id="re-review">
                <p>REVIEW FORM HERE</p>
                {% csrf_token %}
                {{ reviewForm|crispy }}
                <button id="submitButton" type="submit"
                        class="btn btn-lg btn-warning authentication-button">
                        Submit<i class="fa-solid fa-arrow-right ms-3"></i>
                    </button>
                <button id="btn-cancel-review">Cancel</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script type="text/javascript" src="{% static 'reader/js/profile.js' %}"></script>
<script type="text/javascript" src="{% static 'reader/js/crud.js' %}"></script>
{% endblock %}